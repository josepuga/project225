#!/usr/bin/env python3
# Generates de override.mk for the builder toolchain
# Project225. By JosÃ© Puga 2026

# INTERNAL USE for compile.sh

import pathlib

ROOT = pathlib.Path(__file__).resolve().parents[1]  # project root
data_file = ROOT / "zig/objects.txt"
kernel_root = ROOT  / "kernel-shared"
out_file = ROOT / kernel_root / "zig/override.mk"

def patch_makefiles():
    """
    Adds:
        -include $(TOPDIR)/zig/override.mk
    to every Makefile in the kernel tree.
    Runs only once: checks main Makefile first.
    """

    main_makefile = kernel_root / "Makefile"
    include_line = "-include $(TOPDIR)/zig/override.mk"

    if not main_makefile.exists():
        raise RuntimeError(f"Kernel Makefile not found: {main_makefile}")

    # If already patched do nothing
    if include_line in main_makefile.read_text():
        return

    print("Patching kernel Makefiles. This process runs only once.")
    print("This will take a while...")

    for mk in kernel_root.rglob("Makefile"):

        text = mk.read_text()

        # avoid double patch
        if include_line in text:
            continue

        # append include at end (kernel 2.2 friendly)
        mk.write_text(text.rstrip() + "\n\n" + include_line + "\n")

    print("Patch completed.")




header = """\
# Autogenerated. Do not edit.
# Project225 Zig overrides

.PHONY: FORCE
FORCE:
"""

rule = """\
{c_obj}:  FORCE
\t@if [ -f "$(TOPDIR)/{zig_obj}" ]; then \\
\t\techo "  ZIG:   $@ -> {zig_obj}"; \\
\t\tcp -f "$(TOPDIR)/{zig_obj}" $@; \\
\telse \\
\t\techo "  ZIG:   $@ -> using C object"; \\
\tfi

"""


def main():
    patch_makefiles()
    out = [header]

    for line in data_file.read_text().splitlines():
        line = line.strip()

        if not line or line.startswith("#"):
            continue

        if ":" not in line:
            raise ValueError(f"Invalid line: {line}")

        c_obj, zig_obj = map(str.strip, line.split(":", 1))

        out.append(
            rule.format(
                c_obj=c_obj,
                zig_obj=zig_obj,
            )
        )

    #  compile.sh checks disk access before
    out_file.write_text("".join(out))


if __name__ == "__main__":
    # main()
    print("Skipping override.mk at the moment...")
