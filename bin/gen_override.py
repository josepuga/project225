#!/usr/bin/env python3
# Generates de override.mk for the builder toolchain
# Project225. By JosÃ© Puga 2026

# INTERNAL USE for compile.sh

import pathlib

ROOT = pathlib.Path(__file__).resolve().parents[1]  # project root
data_file = ROOT / "zig/objects.txt"
out_file = ROOT / "kernel-shared/zig/override.mk"

header = """\
# Autogenerated. Do not edit.
# Project225 Zig overrides

"""

rule = """\
{c_obj}:
\t@if [ -f "$(TOPDIR)/{zig_obj}" ]; then \\
\t\techo "  ZIG:   $@ -> $<"; \\
\t\tcp -f "$(TOPDIR)/{zig_obj}" $@; \\
\telse \\
\t\techo "  ZIG:   $@ -> using C object"; \\
\tfi

"""


def main():
    out = [header]

    for line in data_file.read_text().splitlines():
        line = line.strip()

        if not line or line.startswith("#"):
            continue

        if ":" not in line:
            raise ValueError(f"Invalid line: {line}")

        c_obj, zig_obj = map(str.strip, line.split(":", 1))

        out.append(
            rule.format(
                c_obj=c_obj,
                zig_obj=zig_obj,
            )
        )

    #  compile.sh checks disk access before
    out_file.write_text("".join(out))


if __name__ == "__main__":
    main()
